<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Clifford â€“ Music Events (Admin Mode)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      margin: 20px;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
    }
    form, #filterContainer, #adminToggleContainer {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      max-width: 600px;
      margin: 0 auto 20px auto;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input, select, textarea, button {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
      font-size: 14px;
    }
    button {
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #219150;
    }
    #map {
      height: 200px;
      max-width: 900px;
      margin: 0 auto 20px auto;
      border-radius: 8px;
    }
    #eventList, #pendingList {
      max-width: 600px;
      margin: 20px auto;
    }
    .event {
      background: #fff;
      padding: 10px 10px 10px 15px;
      margin-bottom: 10px;
      border-left: 5px solid #2980b9;
      border-radius: 4px;
      position: relative;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .pending {
      border-left-color: #f39c12;
      background: #fff8e1;
    }
    .delete-btn, .approve-btn {
      position: absolute;
      top: 8px;
      width: 50px;
      height: 22px;
      font-size: 10px;
      color: #fff;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      z-index: 1;
    }
    .delete-btn {
      right: 8px;
      background: #c0392b;
      display: none;
    }
    .delete-btn:hover {
      background: #a83228;
    }
    .approve-btn {
      right: 65px;
      background: #27ae60;
      display: none;
    }
    .approve-btn:hover {
      background: #219150;
    }
    #adminToggleContainer {
      text-align: center;
    }
    #pendingHeader {
      max-width: 600px;
      margin: 20px auto 5px auto;
      font-weight: bold;
      color: #f39c12;
    }
  </style>
</head>
<body>

  <h1>ðŸŽ· Clifford â€“ Music Events</h1>

  <form id="eventForm">
    <label>Create Event Title: <input type="text" id="title" required /></label>
    <label>Date & Time: <input type="datetime-local" id="datetime" required /></label>
    <label>Music Style:
      <select id="style" required>
        <option value="">-- Choose --</option>
        <option>Jazz</option><option>Rock</option><option>Classical</option>
        <option>Electronic</option><option>Jam Session</option>
        <option>Pop</option><option>Hip-hop</option><option>Folk</option>
        <option>Metal</option><option>Blues</option><option>Other</option>
      </select>
    </label>
    <label>Location: <input type="text" id="location" placeholder="e.g. Vienna, Austria" required /></label>
    <label>Description: <textarea id="description"></textarea></label>
    <button type="submit">Add Event</button>
  </form>

  <div id="filterContainer">
    <label for="styleFilter">Find Event by Music Style:</label>
    <select id="styleFilter">
      <option value="">All Styles</option>
      <option>Jazz</option><option>Rock</option><option>Classical</option>
      <option>Electronic</option><option>Jam Session</option>
      <option>Pop</option><option>Hip-hop</option><option>Folk</option>
      <option>Metal</option><option>Blues</option><option>Other</option>
    </select>
  </div>

  <div id="map"></div>

  <div id="eventList"></div>

  <div id="pendingHeader" style="display:none;">Pending Events (Admin only):</div>
  <div id="pendingList"></div>

  <div id="adminToggleContainer">
    <label><input type="checkbox" id="adminToggle" /> Admin Mode (password required)</label>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getFirestore, collection, addDoc, getDocs,
      deleteDoc, doc, orderBy, query, setDoc, getDoc
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBylr8Qgxzw263rInUmln4AYMpibm1t43o",
      authDomain: "clifford-146ae.firebaseapp.com",
      projectId: "clifford-146ae",
      storageBucket: "clifford-146ae.appspot.com",
      messagingSenderId: "655375890963",
      appId: "1:655375890963:web:0153ed600a917c222c9de6"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const form = document.getElementById("eventForm");
    const styleFilter = document.getElementById("styleFilter");
    const eventList = document.getElementById("eventList");
    const pendingList = document.getElementById("pendingList");
    const pendingHeader = document.getElementById("pendingHeader");
    const adminToggle = document.getElementById("adminToggle");

    const PASSWORD = "2412";
    let isAdmin = false;
    let eventsData = [];
    let pendingData = [];
    let markers = [];

    const map = L.map("map").setView([48.2082, 16.3738], 5);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "&copy; OpenStreetMap contributors"
    }).addTo(map);

    async function geocode(loc) {
      const resp = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(loc)}`
      );
      const data = await resp.json();
      if (!data.length) throw new Error("Location not found.");
      return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
    }

    function showDeleteButtons(show) {
      document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.style.display = show ? "inline-block" : "none";
      });
      document.querySelectorAll(".approve-btn").forEach(btn => {
        btn.style.display = show ? "inline-block" : "none";
      });
    }

    async function loadEvents() {
      markers.forEach(m => map.removeLayer(m));
      markers = [];
      eventList.innerHTML = "";
      pendingList.innerHTML = "";
      pendingHeader.style.display = "none";

      // Load approved events
      const snap = await getDocs(query(collection(db, "events"), orderBy("datetime", "asc")));
      eventsData = snap.docs.map(d => ({ id: d.id, ...d.data() }));

      // Load pending events only if admin
      if (isAdmin) {
        const pendingSnap = await getDocs(query(collection(db, "pendingEvents"), orderBy("datetime", "asc")));
        pendingData = pendingSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      } else {
        pendingData = [];
      }

      displayEvents();
      if (isAdmin) displayPendingEvents();
    }

    function displayEvents() {
      eventList.innerHTML = "";
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      const filtered = styleFilter.value
        ? eventsData.filter(e => e.style === styleFilter.value)
        : eventsData;

      if (!filtered.length) {
        eventList.innerHTML = "<p>No events found.</p>";
        return;
      }

      filtered.forEach(e => {
        const div = document.createElement("div");
        div.className = "event";
        div.innerHTML = `
          <button class="delete-btn" data-id="${e.id}">Del</button>
          <strong>${e.title}</strong><br/>
          ${new Date(e.datetime).toLocaleString()}<br/>
          ${e.style}<br/>
          ${e.location}<br/>
          ${e.description ? `<p>${e.description}</p>` : ""}
        `;
        eventList.appendChild(div);

        const m = L.marker([e.lat, e.lng])
          .addTo(map)
          .bindPopup(`<strong>${e.title}</strong><br/>${e.location}`);
        markers.push(m);
      });

      showDeleteButtons(isAdmin);

      if (isAdmin) {
        document.querySelectorAll(".delete-btn").forEach(btn => {
          btn.onclick = async () => {
            if (confirm("Delete this event?")) {
              await deleteDoc(doc(db, "events", btn.dataset.id));
              loadEvents();
            }
          };
        });
      }
    }

    function displayPendingEvents() {
      pendingList.innerHTML = "";
      pendingHeader.style.display = pendingData.length ? "block" : "none";

      const filtered = styleFilter.value
        ? pendingData.filter(e => e.style === styleFilter.value)
        : pendingData;

      if (!filtered.length) {
        if(pendingData.length) {
          pendingList.innerHTML = "<p>No pending events match this filter.</p>";
        } else {
          pendingList.innerHTML = "";
        }
        return;
      }

      filtered.forEach(e => {
        const div = document.createElement("div");
        div.className = "event pending";
        div.innerHTML = `
          <button class="approve-btn" data-id="${e.id}">Approve</button>
          <button class="delete-btn" data-id="${e.id}">Del</button>
          <strong>${e.title}</strong><br/>
          ${new Date(e.datetime).toLocaleString()}<br/>
          ${e.style}<br/>
          ${e.location}<br/>
          ${e.description ? `<p>${e.description}</p>` : ""}
        `;
        pendingList.appendChild(div);
      });

      showDeleteButtons(true); // always show delete & approve in pending list

      document.querySelectorAll("#pendingList .delete-btn").forEach(btn => {
        btn.onclick = async () => {
          if (confirm("Delete this pending event?")) {
            await deleteDoc(doc(db, "pendingEvents", btn.dataset.id));
            loadEvents();
          }
        };
      });

      document.querySelectorAll("#pendingList .approve-btn").forEach(btn => {
        btn.onclick = async () => {
          if (confirm("Approve this pending

          if (confirm("Approve this pending event?")) {
            const pendingDocRef = doc(db, "pendingEvents", btn.dataset.id);
            const pendingDoc = await getDoc(pendingDocRef);
            if (pendingDoc.exists()) {
              const data = pendingDoc.data();
              // SkopÃ­ruj event do kolekcie "events"
              await setDoc(doc(db, "events", btn.dataset.id), data);
              // VymaÅ¾ event z pending
              await deleteDoc(pendingDocRef);
              loadEvents();
            } else {
              alert("Pending event no longer exists.");
              loadEvents();
            }
          }
        };
      });
    }

    form.onsubmit = async (e) => {
      e.preventDefault();
      const title = form.title.value.trim();
      const datetime = form.datetime.value;
      const style = form.style.value;
      const location = form.location.value.trim();
      const description = form.description.value.trim();

      if (!title || !datetime || !style || !location) {
        alert("Please fill all required fields.");
        return;
      }

      try {
        const coords = await geocode(location);
        await addDoc(collection(db, "events"), {
          title,
          datetime,
          style,
          location,
          description,
          lat: coords.lat,
          lng: coords.lng,
          createdAt: new Date().toISOString()
        });
        form.reset();
        loadEvents();
        alert("Event added successfully!");
      } catch (err) {
        alert("Error adding event: " + err.message);
      }
    };

    styleFilter.onchange = () => {
      displayEvents();
      if (isAdmin) displayPendingEvents();
    };

    adminToggle.onchange = async () => {
      if (adminToggle.checked) {
        const pw = prompt("Enter admin password:");
        if (pw === PASSWORD) {
          isAdmin = true;
          form.style.display = "block";
          pendingHeader.style.display = "block";
        } else {
          alert("Wrong password!");
          adminToggle.checked = false;
          isAdmin = false;
          form.style.display = "none";
          pendingHeader.style.display = "none";
        }
      } else {
        isAdmin = false;
        form.style.display = "none";
        pendingHeader.style.display = "none";
      }
      await loadEvents();
    };

    // Default - hide form
    form.style.display = "none";

    loadEvents();
  </script>

</body>
</html>
